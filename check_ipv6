#!/bin/sh

# === 配置区 ===
DEVICE_NAME="OpenWRT-客厅路由"   # ← 在这里改成你的设备名称
WEBHOOK_URL="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key="  

# === 检查IPv6状态 ===
IPV6PD=$(ubus call network.interface.wan6 status | grep -A 3 '"ipv6-prefix":' | grep address | awk '{print $2}')

if [ "$IPV6PD" != "" ]; then
    MSG="✅ [$DEVICE_NAME] 网络正常：检测到IPv6前缀 $IPV6PD"
    echo "network OK"
else
    ubus call network.interface.wan6 down
    sleep 1
    ubus call network.interface.wan6 up
    sleep 1
    /etc/init.d/odhcpd restart
    MSG="⚠️ [$DEVICE_NAME] 检测到IPv6前缀为空，已执行网络重启操作。"
fi

# === 推送到企业微信机器人 ===
curl -s "$WEBHOOK_URL" \
  -H "Content-Type: application/json" \
  -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"$(date '+%Y-%m-%d %H:%M:%S')\n$MSG\"}}"

exit 0
